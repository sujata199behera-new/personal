<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Custom Ratio Image Cropper + Download</title>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" />
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <style>
    :root { --primary:#0078d7; --primaryHover:#005fa3; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; padding:24px; background:#f7f7f8; color:#111; display:flex; flex-direction:column; align-items:center; }
    h1 { margin:0 0 16px; }
    .panel { width:100%; max-width:960px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    label { font-size:14px; color:#374151; }
    input[type="number"], input[type="text"], select { padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; min-width:72px; }
    input[type="file"] { padding:8px 0; }
    #imageContainer { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    #stage { flex:1 1 420px; min-height:300px; border:2px dashed #cbd5e1; border-radius:12px; display:flex; align-items:center; justify-content:center; background:#fafafa; padding:12px; }
    #preview { max-width:100%; display:none; }
    #outputContainer { text-align:center; }
    #outputCanvas { max-width:100%; border:1px solid #e5e7eb; border-radius:8px; }
    button { background:var(--primary); color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; }
    button:hover { background:var(--primaryHover); }
    .ghost { background:#e5e7eb; color:#111; }
    .ghost:hover { background:#d1d5db; }
    .muted { color:#6b7280; font-size:12px; }
    #directLink { display:inline-block; margin-top:10px; word-break:break-all; }
  </style>
</head>
<body>
  <h1>ðŸ“¸ Custom Ratio Image Cropper</h1>

  <!-- Controls -->
  <div class="panel">
    <div class="row">
      <label><strong>Aspect Ratio</strong></label>
      <input type="number" id="ratioWidth" value="3" min="1" step="1" aria-label="Aspect ratio width"/> :
      <input type="number" id="ratioHeight" value="4" min="1" step="1" aria-label="Aspect ratio height"/>
      <button id="updateRatio">Set Ratio</button>
      <span class="muted">Default 3:4 (portrait)</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label><strong>Export Width</strong></label>
      <input type="number" id="exportWidth" value="1080" min="64" step="1" />
      <span class="muted">Height auto-calculated from ratio</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label><strong>Download Format</strong></label>
      <select id="format">
        <option value="image/png">PNG</option>
        <option value="image/jpeg">JPEG</option>
      </select>
      <label><strong>JPEG Quality</strong></label>
      <input type="number" id="quality" value="0.92" min="0" max="1" step="0.01"/>
      <span class="muted">Only for JPEG</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label><strong>Filename suffix</strong></label>
      <input type="text" id="suffix" value="_cropped" />
      <button id="cropButton" class="ghost">Preview Crop</button>
      <button id="downloadButton">Download</button>
    </div>
    <div class="row">
      <a id="directLink" class="muted" href="#" target="_blank" rel="noopener">Direct link will appear here after preview/download</a>
    </div>
  </div>

  <!-- Workspace -->
  <div class="panel" id="imageContainer">
    <div class="row" style="width:100%; justify-content:space-between;">
      <div>
        <input type="file" id="imageInput" accept="image/*" />
        <div class="muted">Tip: pinch/scroll to zoom, drag to move.</div>
      </div>
    </div>

    <div id="stage">
      <img id="preview" alt="Upload to start cropping"/>
      <span id="placeholder" class="muted">Upload an image to begin</span>
    </div>
  </div>

  <!-- Output -->
  <div class="panel" id="outputContainer">
    <h2>Cropped Output</h2>
    <canvas id="outputCanvas"></canvas>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const placeholder = document.getElementById('placeholder');
    const cropButton = document.getElementById('cropButton');
    const downloadButton = document.getElementById('downloadButton');
    const outputCanvas = document.getElementById('outputCanvas');
    const directLink = document.getElementById('directLink');

    const ratioWidth = document.getElementById('ratioWidth');
    const ratioHeight = document.getElementById('ratioHeight');
    const updateRatioButton = document.getElementById('updateRatio');

    const exportWidthInput = document.getElementById('exportWidth');
    const formatSelect = document.getElementById('format');
    const qualityInput = document.getElementById('quality');
    const suffixInput = document.getElementById('suffix');

    let cropper;
    let currentRatio = 9 / 16; // default 9:16
    let originalFilename = "";  // store uploaded filename

    function ensureCropper() {
      if (!cropper) alert('Please upload an image first.');
      return !!cropper;
    }

    function getBaseAndExt(name) {
      const lastDot = name.lastIndexOf('.');
      if (lastDot <= 0) return { base: name, ext: '' };
      return { base: name.slice(0, lastDot), ext: name.slice(lastDot + 1).toLowerCase() };
    }

    imageInput.addEventListener('change', (event) => {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      originalFilename = file.name || "image";

      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        if (placeholder) placeholder.style.display = 'none';

        if (cropper) cropper.destroy();

        cropper = new Cropper(preview, {
          aspectRatio: currentRatio,
          viewMode: 1,
          movable: true,
          zoomable: true,
          rotatable: false,
          scalable: false,
          responsive: true,
        });
      };
      reader.readAsDataURL(file);
    });

    updateRatioButton.addEventListener('click', () => {
      const w = parseFloat(ratioWidth.value);
      const h = parseFloat(ratioHeight.value);
      if (!(w > 0 && h > 0)) {
        alert('Please enter valid ratio numbers greater than 0.');
        return;
      }
      currentRatio = w / h;
      if (cropper) cropper.setAspectRatio(currentRatio);
    });

    function getCroppedCanvas() {
      const exportWidth = Math.max(1, Math.floor(parseFloat(exportWidthInput.value) || 1080));
      const exportHeight = Math.max(1, Math.round(exportWidth / currentRatio));
      const c = cropper.getCroppedCanvas({ width: exportWidth, height: exportHeight });
      if (!c) alert('Unable to create canvas. Try a different selection.');
      return c;
    }

    function updatePreview(canvas) {
      const ctx = outputCanvas.getContext('2d');
      outputCanvas.width = canvas.width;
      outputCanvas.height = canvas.height;
      ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
      ctx.drawImage(canvas, 0, 0);
    }

    function mimeToExt(mime) {
      return mime === 'image/jpeg' ? 'jpg' : 'png';
    }

    function makeFilename(mime) {
      const { base } = getBaseAndExt(originalFilename || 'image');
      const suffix = (suffixInput.value || '_cropped').trim() || '_cropped';
      const ext = mimeToExt(mime);
      return `${base}${suffix}.${ext}`;
    }

    // iOS / Safari detection
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }
    function isSafari() {
      return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    }

    function createDataURL(canvas, mime, quality) {
      // Always create a data URL; this works universally (even where Blob download is restricted)
      return canvas.toDataURL(mime, quality);
    }

    function triggerDownloadDataURL(dataURL, filename) {
      // Show/update the visible fallback link for manual save if needed
      directLink.href = dataURL;
      directLink.textContent = `If download doesn't start, tap/click here to open and save: ${filename}`;
      directLink.setAttribute('download', filename);

      // iOS/Safari often block download attr for data URLs; open in a new tab
      if (isIOS() || isSafari()) {
        window.open(dataURL, '_blank', 'noopener');
        return;
      }

      // Other browsers: simulate anchor click with download attr
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = filename;
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    cropButton.addEventListener('click', () => {
      if (!ensureCropper()) return;
      const c = getCroppedCanvas();
      if (!c) return;
      updatePreview(c);

      const mime = formatSelect.value;
      const quality = Math.min(1, Math.max(0, parseFloat(qualityInput.value) || 0.92));
      const dataURL = createDataURL(c, mime, quality);
      const filename = makeFilename(mime);

      // Update direct link immediately on preview
      directLink.href = dataURL;
      directLink.textContent = `Open cropped image: ${filename}`;
      directLink.setAttribute('download', filename);
    });

    downloadButton.addEventListener('click', () => {
      if (!ensureCropper()) return;
      const c = getCroppedCanvas();
      if (!c) return;

      updatePreview(c);

      const mime = formatSelect.value;
      const quality = Math.min(1, Math.max(0, parseFloat(qualityInput.value) || 0.92));
      const dataURL = createDataURL(c, mime, quality);
      const filename = makeFilename(mime);

      triggerDownloadDataURL(dataURL, filename);
    });

    function syncQualityState() {
      const isJPEG = formatSelect.value === 'image/jpeg';
      qualityInput.disabled = !isJPEG;
      qualityInput.style.opacity = isJPEG ? '1' : '0.6';
      qualityInput.title = isJPEG ? '' : 'Quality only applies to JPEG';
    }
    formatSelect.addEventListener('change', syncQualityState);
    syncQualityState();
  </script>
</body>
</html>
